#!/bin/bash

# Run all models in this directory. Note that resolution 8 and ppd 96 requires 192-384 GB of RAM

for stokes_degree in 2 3; do #3
  for discontinuous_pressure in false; do # true
    for refinement in 3 4 5 6 7 8; do
      for particles_per_direction in 2; do # 2 5 10
        for generator in "reference cell"; do
        for interpolator in "bilinear least squares"; do # cell average

        echo "subsection Discretization" > current.prm
        echo "  set Stokes velocity polynomial degree = $stokes_degree" >> current.prm
        echo "  set Use locally conservative discretization = $discontinuous_pressure" >> current.prm
        echo "end" >> current.prm

        number_of_particles=`echo "$particles_per_direction * $particles_per_direction * 2 ^ (2 * $refinement)" | bc -l`

        echo "subsection Postprocess" >> current.prm
        echo "  subsection Particles" >> current.prm
        echo "  set Number of particles = $number_of_particles" >> current.prm
	echo "  set Particle generator name = $generator" >> current.prm
	echo "  set Interpolation scheme = $interpolator" >> current.prm
        echo "    subsection Generator" >> current.prm
        echo "      subsection Reference cell" >> current.prm
        echo "        set Number of particles per cell per direction = $particles_per_direction" >> current.prm
        echo "      end" >> current.prm
        echo "    end" >> current.prm
        echo "  end" >> current.prm
        echo "end" >> current.prm

        echo "subsection Mesh refinement" >> current.prm
        echo "  set Initial global refinement = $refinement" >> current.prm
        echo "end" >> current.prm


        echo "set Output directory = Q${stokes_degree}_P${discontinuous_pressure}_refinement${refinement}" >> current.prm
        echo "Starting Q${stokes_degree}_P${discontinuous_pressure}_refinement${refinement}"
        cat rigid_shear.prm current.prm | mpirun -np 6 ./aspect --

        done
	done
      done
    done
  done
done
