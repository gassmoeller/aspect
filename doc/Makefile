############################################################
# $Id$
############################################################

aspect-files      = $(shell echo ../include/aspect/*.h \
                            ../include/aspect/*/*h     \
                            ../include/aspect/*/*/*h   \
                            modules/*h)
aspect-manual-pix = $(shell find manual/cookbooks/ -name \*.png)


aspect-prms = $(shell find manual/cookbooks/ -name \*.prm)
aspect-prms-out = $(aspect-prms:=.out)

test:
	@echo "prms: ${aspect-prms}"
	@echo "prm-out: ${aspect-prms-out}"


all: aspect.tag manual.pdf

# generate .prm.out from .prm using the annotate.pl script:
%.prm.out: %.prm
	@echo "generating '$@' from '$<'..."
	@perl manual/cookbooks/annotate.pl $< >$@

# build the documentation. see if we can download the latest
# deal.II deal.tag file generated by doxygen and if so
# use it to cross-reference the deal.II documentation from the
# aspect documentation
aspect.tag: $(aspect-files) options.dox Makefile
	@if test ! -x "`which doxygen`" ; then \
	  echo "-----------------------------------------" ; \
	  echo "Can't find 'doxygen'." ; \
	  echo "-----------------------------------------" ; \
	  false ; \
	 fi
	@echo "=====aspect=================== Generating documentation"
	@echo '@INCLUDE = options.dox'                                > aspect.dox
	@echo 'DOT_IMAGE_FORMAT = png'                               >> aspect.dox
	@if wget -N http://www.dealii.org/developer/doxygen/deal.tag ; then \
	  echo 'Cross-linking deal.II documentation from the ASPECT documentation' ; \
	  echo 'TAGFILES = deal.tag=http://www.dealii.org/developer/doxygen/deal.II'          >> aspect.dox ; \
	 fi
	@echo 'IMAGE_PATH = manual'                                  >> aspect.dox
	@echo 'PROJECT_NAME = "ASPECT Mantle Convection Simulator"'  >> aspect.dox
	@echo 'INPUT = $(aspect-files)'                              >> aspect.dox
	@echo 'HTML_OUTPUT      = doxygen'                           >> aspect.dox
	@echo 'GENERATE_TAGFILE = $@'                                >> aspect.dox
	@doxygen aspect.dox || echo "Running doxygen to generate documentation failed."

manual.pdf: manual/manual.tex manual/manual.bib manual/parameters.tex \
            $(aspect-manual-pix) $(aspect-prms-out)
	@if test -x "`which pdflatex`" \
                 -a -x "`which bibtex`" \
                 -a -x "`which makeindex`" ; then \
	   (cd manual ; \
		rm -f manual.{aux,bbl,blg,log,out,pdf,toc} prm*.{idx,ilg,ind} ; \
		pdflatex manual.tex ; \
		bibtex manual       ; \
		makeindex prmindex  ; \
		pdflatex manual.tex ; \
		pdflatex manual.tex ; \
		pdflatex manual.tex) ; \
	   mv manual/manual.pdf . ; \
         else \
	  echo "------------------------------------------------------" ; \
	  echo "Can't find either 'pdflatex', 'bibtex' or 'makeindex'." ; \
	  echo "------------------------------------------------------" ; \
	  false ; \
	 fi

clean:
	-rm -f aspect.dox aspect.tag
	-rm -rf doxygen
	-rm -rf manual/*.{blg,toc,log,out,bbl}
